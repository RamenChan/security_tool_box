import sys
import hashlib
import os
from datetime import datetime

def calculate_hash(data):
    return {
        'md5': hashlib.md5(data).hexdigest(),
        'sha1': hashlib.sha1(data).hexdigest(),
        'sha256': hashlib.sha256(data).hexdigest()
    }

def check_virustotal_hash(file_hash):
    print(f"\n[*] VirusTotal kontrolü için hash:")
    print(f"    https://www.virustotal.com/gui/file/{file_hash}")

def analyze_malware(filepath):
    print(f"[*] Malware analizi başlatılıyor: {filepath}\n")
    
    if not os.path.exists(filepath):
        print(f"[!] Dosya bulunamadı: {filepath}")
        return
    
    print("="*60)
    print("MALWARE ANALİZ RAPORU")
    print("="*60 + "\n")
    
    stat_info = os.stat(filepath)
    
    print("Dosya Bilgileri:")
    print("-"*60)
    print(f"Dosya Adı    : {os.path.basename(filepath)}")
    print(f"Dosya Yolu   : {filepath}")
    print(f"Boyut        : {stat_info.st_size:,} bytes ({stat_info.st_size / 1024:.2f} KB)")
    print(f"Oluşturulma  : {datetime.fromtimestamp(stat_info.st_ctime).strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"Değiştirilme : {datetime.fromtimestamp(stat_info.st_mtime).strftime('%Y-%m-%d %H:%M:%S')}")
    
    try:
        with open(filepath, 'rb') as f:
            data = f.read()
        
        hashes = calculate_hash(data)
        
        print("\nHash Değerleri:")
        print("-"*60)
        print(f"MD5    : {hashes['md5']}")
        print(f"SHA1   : {hashes['sha1']}")
        print(f"SHA256 : {hashes['sha256']}")
        
        check_virustotal_hash(hashes['sha256'])
        
        print("\n\nDosya Türü Analizi:")
        print("-"*60)
        
        header = data[:16]
        
        file_signatures = {
            b'\x4D\x5A': ('Windows PE Executable', 'Yüksek'),
            b'\x7F\x45\x4C\x46': ('Linux ELF Executable', 'Yüksek'),
            b'\x50\x4B\x03\x04': ('ZIP Archive (Potansiyel Trojan)', 'Orta'),
            b'\x52\x61\x72\x21': ('RAR Archive', 'Orta'),
            b'\xFF\xD8\xFF': ('JPEG Image (Steganografi riski)', 'Düşük'),
            b'\x89\x50\x4E\x47': ('PNG Image (Steganografi riski)', 'Düşük'),
            b'\x25\x50\x44\x46': ('PDF Document (Exploit riski)', 'Orta'),
            b'\xD0\xCF\x11\xE0': ('MS Office Document (Macro riski)', 'Yüksek')
        }
        
        detected = False
        for signature, (file_type, risk) in file_signatures.items():
            if header.startswith(signature):
                print(f"Dosya Türü   : {file_type}")
                print(f"Risk Seviyesi: {risk}")
                detected = True
                break
        
        if not detected:
            print("Dosya Türü   : Bilinmeyen")
            print("Risk Seviyesi: Belirsiz")
        
        print("\n\nŞüpheli İçerik Analizi:")
        print("-"*60)
        
        suspicious_strings = [
            (b'cmd.exe', 'Komut satırı çalıştırma'),
            (b'powershell', 'PowerShell kullanımı'),
            (b'reg add', 'Registry değişikliği'),
            (b'HKEY_', 'Registry erişimi'),
            (b'CreateRemoteThread', 'Process injection'),
            (b'VirtualAlloc', 'Bellek tahsisi'),
            (b'WriteProcessMemory', 'Process memory yazma'),
            (b'LoadLibrary', 'DLL yükleme'),
            (b'GetProcAddress', 'API adresi alma'),
            (b'WinExec', 'Program çalıştırma'),
            (b'ShellExecute', 'Shell komutu çalıştırma'),
            (b'URLDownloadToFile', 'Dosya indirme'),
            (b'InternetOpen', 'İnternet bağlantısı'),
            (b'socket', 'Ağ bağlantısı'),
            (b'bind', 'Port dinleme'),
            (b'listen', 'Bağlantı bekleme'),
            (b'accept', 'Bağlantı kabul etme'),
            (b'keylogger', 'Keylogger'),
            (b'password', 'Şifre çalma'),
            (b'credential', 'Kimlik bilgisi'),
            (b'bitcoin', 'Kripto para'),
            (b'ransomware', 'Fidye yazılımı'),
            (b'encrypt', 'Şifreleme'),
            (b'decrypt', 'Şifre çözme')
        ]
        
        findings = []
        
        for pattern, description in suspicious_strings:
            if pattern in data:
                findings.append((pattern.decode('utf-8', errors='ignore'), description))
        
        if findings:
            print(f"\n[!] {len(findings)} şüpheli string bulundu:\n")
            for pattern, description in findings:
                print(f"  [!] {pattern:<25} - {description}")
        else:
            print("\n[+] Şüpheli string bulunamadı.")
        
        print("\n\nIP Adresi ve URL Analizi:")
        print("-"*60)
        
        import re
        
        text_data = data.decode('utf-8', errors='ignore')
        
        ip_pattern = r'\b(?:\d{1,3}\.){3}\d{1,3}\b'
        url_pattern = r'https?://[^\s<>"{}|\\^`\[\]]+'
        
        ips = re.findall(ip_pattern, text_data)
        urls = re.findall(url_pattern, text_data)
        
        if ips:
            print(f"\n[!] {len(set(ips))} IP adresi bulundu:")
            for ip in set(ips)[:10]:
                print(f"  - {ip}")
        
        if urls:
            print(f"\n[!] {len(set(urls))} URL bulundu:")
            for url in set(urls)[:10]:
                print(f"  - {url}")
        
        if not ips and not urls:
            print("\n[+] IP adresi veya URL bulunamadı.")
        
        print("\n\nEntropy Analizi:")
        print("-"*60)
        
        entropy = calculate_entropy(data)
        print(f"Entropy: {entropy:.4f}")
        
        if entropy > 7.5:
            print("[!] YÜKSEK ENTROPY - Dosya şifrelenmiş veya sıkıştırılmış olabilir!")
        elif entropy > 6.5:
            print("[~] ORTA ENTROPY - Dosya kısmen şifrelenmiş olabilir.")
        else:
            print("[+] DÜŞÜK ENTROPY - Normal dosya.")
        
        print("\n" + "="*60)
        print("ANALİZ TAMAMLANDI")
        print("="*60)
        
    except Exception as e:
        print(f"[!] Analiz hatası: {e}")

def calculate_entropy(data):
    if not data:
        return 0
    
    entropy = 0
    byte_counts = [0] * 256
    
    for byte in data:
        byte_counts[byte] += 1
    
    data_len = len(data)
    
    for count in byte_counts:
        if count == 0:
            continue
        
        probability = count / data_len
        entropy -= probability * (probability.bit_length() - 1)
    
    import math
    return entropy / math.log(2)

def batch_analyze(directory):
    print(f"[*] Dizindeki dosyalar analiz ediliyor: {directory}\n")
    
    if not os.path.isdir(directory):
        print(f"[!] Dizin bulunamadı: {directory}")
        return
    
    suspicious_files = []
    
    for root, dirs, files in os.walk(directory):
        for file in files:
            filepath = os.path.join(root, file)
            
            try:
                with open(filepath, 'rb') as f:
                    data = f.read(1024)
                
                entropy = calculate_entropy(data)
                
                if entropy > 7.5:
                    suspicious_files.append((filepath, entropy))
                    print(f"[!] ŞÜPHELİ: {filepath} (Entropy: {entropy:.4f})")
                    
            except Exception:
                pass
    
    print(f"\n[*] {len(suspicious_files)} şüpheli dosya bulundu.")

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Kullanım:")
        print("  Dosya analizi: python malware_detector.py analyze <dosya>")
        print("  Toplu analiz : python malware_detector.py batch <dizin>")
        print("\nÖrnekler:")
        print("  python malware_detector.py analyze suspicious.exe")
        print("  python malware_detector.py batch /tmp/downloads")
        sys.exit()
    
    command = sys.argv[1]
    
    if command == 'analyze' and len(sys.argv) >= 3:
        filepath = sys.argv[2]
        analyze_malware(filepath)
    elif command == 'batch' and len(sys.argv) >= 3:
        directory = sys.argv[2]
        batch_analyze(directory)
    else:
        print("[!] Geçersiz kullanım!")
